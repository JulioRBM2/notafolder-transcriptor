<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcriptor Notafolder</title>
    <style>
        /* --- ESTILOS VISUALES --- */
        :root {
            --brand-color: #005aa2; /* Azul Notafolder */
            --brand-hover: #00447a;
            --bg-color: #f8fafc;
            --text-color: #334155;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; display: flex; justify-content: center; }
        
        .container { width: 100%; max-width: 600px; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }

        h2 { margin-top: 0; color: var(--brand-color); font-weight: 700; text-align: center; margin-bottom: 20px; }
        p.desc { text-align: center; color: #64748b; margin-bottom: 30px; font-size: 0.95rem; }

        /* √Årea de subida */
        .upload-box { border: 2px dashed #cbd5e1; padding: 30px; border-radius: 10px; text-align: center; transition: 0.2s; background: #fdfdfd; cursor: pointer; position: relative; }
        .upload-box:hover { border-color: var(--brand-color); background: #eff6ff; }
        .upload-box input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .upload-label { font-weight: 600; color: #64748b; pointer-events: none; }
        
        /* Bot√≥n Principal */
        .btn-action { background-color: var(--brand-color); color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; width: 100%; margin-top: 20px; transition: background 0.2s, transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-action:hover { background-color: var(--brand-hover); }
        .btn-action:active { transform: translateY(1px); }
        .btn-action:disabled { background-color: #94a3b8; cursor: not-allowed; transform: none; }

        /* --- ANIMACIONES DE CARGA --- */
        #loader-area { display: none; margin-top: 25px; }
        
        .progress-container { width: 100%; background-color: #e2e8f0; border-radius: 99px; height: 10px; overflow: hidden; margin-bottom: 15px; }
        .progress-bar { height: 100%; background-color: var(--brand-color); width: 0%; transition: width 0.4s ease; border-radius: 99px; }
        
        .status-text { text-align: center; font-size: 0.9rem; font-weight: 600; color: var(--brand-color); min-height: 20px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        /* Spinner peque√±o giratorio */
        .spinner { width: 16px; height: 16px; border: 3px solid #e2e8f0; border-top: 3px solid var(--brand-color); border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- RESULTADO --- */
        #result-area { display: none; margin-top: 30px; border-top: 2px solid #f1f5f9; padding-top: 20px; }
        .lyrics-content { white-space: pre-wrap; font-family: 'Segoe UI', sans-serif; line-height: 1.7; background: #fff; color: #1e293b; font-size: 1.05rem; }
        .tag { color: var(--brand-color); font-weight: 800; font-size: 0.8rem; letter-spacing: 1px; display: block; margin-top: 20px; margin-bottom: 5px; border-bottom: 1px solid #e2e8f0; padding-bottom: 2px; }
        
        .btn-copy { background: white; color: var(--brand-color); border: 2px solid var(--brand-color); padding: 10px; width: 100%; border-radius: 6px; font-weight: 700; cursor: pointer; margin-top: 20px; }
        .btn-copy:hover { background: #f0f9ff; }
    </style>
</head>
<body>

<div class="container">
    <h2>Transcriptor Musical Notafolder</h2>
    <p class="desc">Sube tu archivo de audio para obtener la letra estructurada.</p>

    <div class="upload-box">
        <input type="file" id="audioInput" accept="audio/*" onchange="mostrarNombre()">
        <div class="upload-label" id="fileLabel">üìÅ Toca para subir tu audio</div>
    </div>

    <button id="btnProcesar" class="btn-action" onclick="iniciarProceso()">Transcribir Canci√≥n</button>

    <div id="loader-area">
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="status-text" id="statusText">
            <span class="spinner"></span> <span id="msg">Iniciando...</span>
        </div>
    </div>

    <div id="result-area">
        <div class="lyrics-content" id="lyricsBox"></div>
        <button class="btn-copy" onclick="copiarTexto()">üìã Copiar Letra</button>
    </div>
</div>

<script>
    let progressInterval;

    // Mostrar nombre del archivo al seleccionarlo
    function mostrarNombre() {
        const input = document.getElementById('audioInput');
        const label = document.getElementById('fileLabel');
        if (input.files && input.files[0]) {
            label.textContent = "‚úÖ Archivo seleccionado: " + input.files[0].name;
            label.style.color = "#005aa2";
        }
    }

    async function iniciarProceso() {
        const fileInput = document.getElementById('audioInput');
        const btn = document.getElementById('btnProcesar');
        const loaderArea = document.getElementById('loader-area');
        const resultArea = document.getElementById('result-area');
        const lyricsBox = document.getElementById('lyricsBox');
        
        // Validaciones
        if(fileInput.files.length === 0) return alert("Por favor selecciona un archivo de audio primero.");
        if(fileInput.files[0].size > 4.5 * 1024 * 1024) return alert("‚ö†Ô∏è El archivo es muy pesado. M√°ximo 4.5MB para la versi√≥n gratuita.");

        // Resetear interfaz
        btn.disabled = true;
        resultArea.style.display = 'none';
        loaderArea.style.display = 'block';
        lyricsBox.innerHTML = "";
        
        // --- ANIMACI√ìN FALSA DE PROGRESO ---
        let width = 0;
        const progressBar = document.getElementById('progressBar');
        const msgElement = document.getElementById('msg');
        
        const mensajes = [
            "üéß Subiendo y escuchando audio...",
            "üß† Analizando la estructura musical...",
            "üßπ Limpiando ruidos y saludos...",
            "‚úçÔ∏è Escribiendo Versos y Coros...",
            "‚ú® Dando los toques finales..."
        ];

        // Funci√≥n que avanza la barra y cambia el texto
        let msgIndex = 0;
        progressInterval = setInterval(() => {
            if (width >= 90) {
                // Si llega al 90% y aun no termina, se queda esperando ah√≠
            } else {
                width += 2; // Avanza poco a poco
                progressBar.style.width = width + '%';
            }
            
            // Cambiar mensaje cada 20% de avance aprox
            if (width > 20 && width < 40) msgElement.innerText = mensajes[1];
            if (width > 40 && width < 60) msgElement.innerText = mensajes[2];
            if (width > 60 && width < 80) msgElement.innerText = mensajes[3];
            if (width > 80) msgElement.innerText = mensajes[4];

        }, 400); // Se actualiza cada 400ms

        // --- PROCESO REAL (BACKEND) ---
        try {
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            // Llamada al servidor (Netlify Function)
            const response = await fetch('/.netlify/functions/transcribir', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (!response.ok) throw new Error(data.error || "Error al procesar");

            // √âXITO: Completar barra al 100%
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            msgElement.innerText = "‚úÖ ¬°Completado!";
            
            // Formatear y mostrar letra
            setTimeout(() => {
                let html = data.letra.replace(/\[(.*?)\]/g, '<span class="tag">$1</span>');
                lyricsBox.innerHTML = html;
                loaderArea.style.display = 'none'; // Ocultar barra
                resultArea.style.display = 'block'; // Mostrar resultado
                btn.disabled = false;
                btn.innerText = "‚ú® Transcribir otra canci√≥n";
            }, 800); // Peque√±a pausa para ver el 100%

        } catch (error) {
            clearInterval(progressInterval);
            loaderArea.style.display = 'none';
            btn.disabled = false;
            alert("‚ùå Ocurri√≥ un error: " + error.message);
        }
    }

    function copiarTexto() {
        const texto = document.getElementById('lyricsBox').innerText;
        navigator.clipboard.writeText(texto).then(() => {
            alert("¬°Letra copiada al portapapeles!");
        });
    }
</script>

</body>
</html>
